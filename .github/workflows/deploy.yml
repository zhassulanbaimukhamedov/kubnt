name: CI/CD for Kubernetes

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Cache Docker layers
      uses: actions/cache@v2
      with:
        path: ~/.cache/docker
        key: ${{ runner.os }}-docker-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-docker-

    - name: Log in to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      run: |
        docker build -t zasulanb/my-first-image .
        docker push zasulanb/my-first-image

    - name: Set up kubeconfig
      run: |
        mkdir -p ~/.kube
        echo "YXBpVmVyc2lvbjogdjENCmNsdXN0ZXJzOg0KLSBjbHVzdGVyOg0KICAgIGNlcnRpZmljYXRlLWF1dGhvcml0eS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VSS2VrTkRRV2NyWjBGM1NVSkJaMGxEUW01VmQwUlJXVXBMYjFwSmFIWmpUa0ZSUlV4Q1VVRjNUWHBGVmsxQ1RVZEJNVlZGUTJoTlRWSkhiRzRLWVZoU2FHSkZPV3BhVjBaMVRWSnZkMGRCV1VSV1VWRkVSWGhHY2s5SVRtaFpXRTFuVVRKNE1XTXpVbXhqYVVKRVVWUkJaVVozTUhsT1JFVjRUVlJqZUFwTmFra3hUa1JvWVVaM01EQk9SRVY0VFZSamVFMXFTVEZPUkdoaFRVUk5lRVpVUVZSQ1owNVdRa0Z2VkVSRlVuQmFNbXd3V1ZkNFVGa3lWbWhpYWtWaENrMUNaMGRCTVZWRlFYaE5VbUY2YUhwWlYwWjZTVVZPYzJSWVRqQmFXRWxuVVRCRmQyZG5SV2xOUVRCSFExTnhSMU5KWWpORVVVVkNRVkZWUVVFMFNVSUtSSGRCZDJkblJVdEJiMGxDUVZGRVNESnZSVlowSzNOb01YSllURmhMTlZrdk5USkRiMVJrTTBRekwzQldkVE41TUVORVJHNVpOek5VZVV4MU1EVjFOUXB4ZUcxR1ZGcG5iMGcwV0hsNWFscHdPR2xtZDFSaWRrZzJhbkpWTVdOVGFFWklRWGQ1WnpKQ1ZVZEpWbVZXYTJ4UFdWZ3JUMWt4ZFN0dmVTOVpiR1JyQ2xOV0t6TndSVWROTmtkWFNUQk1OR3BOVUV0UFlXNUpZMjlsYjJSV1N5c3ZTbVIxWm1KUWJWaEtkbXRxYjFBcmVYZE9WR2cyZDBOMFExb3dUV2x0VTNNS1EzaHFRMFU1V0RWaU1HSXlWMFZ3TW5KSVJtNUpXalJ2VEVOWWMyeHpaRFYzZDFWV04wSldWa1ZDU0RkaVNTdGFUVzFIYTFNeVNrNWlkSEJ4V0d4UVN3cDNSRFpyY0VKc1N5dDBkbEZGZDJwaGN6UkdUV3QwWWswM0t6Tk9LMWxwUVd4NFV6SnZiM3BHZVVKcVVGVnRPSGhhWWxGMFRFdFRibXREUWxGNVNYTm9DbEF6UW5sT2EyVkpZMFJzUTNvd2NYQlBRV3hoUm5GSGRtdHJSazF5VkVscllpc3hXa0ZuVFVKQlFVZHFVbFJDUkUxQk5FZEJNVlZrUkhkRlFpOTNVVVVLUVhkSlFtaHFRVk5DWjA1V1NGSk5Ra0ZtT0VWRFJFRkhRVkZJTDBGblJVRk5RakJIUVRGVlpFUm5VVmRDUWxKVmJGSk1RVTlsVW1KNWFHSndlbGx6ZUFwUFpIRmtUbUZ6YkhKcVFVNUNaMnR4YUd0cFJ6bDNNRUpCVVhOR1FVRlBRMEZSUlVGdWNpdDVSV3BYTVZwbFYybDJMMWh3TUhaVVJsRjBSVGhyTTBReENrUmtiVmhRWVNzNU9XbFBTMFp5TTJOdVduaEZNMWt4V21WRlZ6VlNaekp4ZDFKTVRGUlhXVmhTUldkTVJHWk9jbVU0UmpkMFluTXdTbFJZYzNRMEsxZ0tRMDVtTUhjM1IxQm1MMWRKVEhKQ1pHcDBVVlpJTjFSVFRISmFXVll6WmpGdVNUSmtRMEV2WjFadldHVm5XVWR5WkcxaU0zbHNXallyU1hoamNWUkhTZ3AzWVV0VFpYWkViRkpqYUhWeU9WZzRNRkZwZGpoNFNWQmxNRm8yVm14RlVURnNOekpOWjBGSk1IUTNhSE52VUhoWlQyUlVVWEJEUWs0ME1YQlZja05XQ2tKbFNuSkZkVlJvYkhJNE5GUTNlWGN6VFU1TGMxVkdjMGhpYWtWV1ZtSTBaVWxNYVhOaGNHNVhlWFJOU1U1b2QzcGhZVVpUTUN0cE1tTkJWVmMxWkdzS2RWSkJkMlp1U2xWT1lVeFlkMmd6TVdOdFkzaDJOWFl6U2pKSGRFSjRUbTFNZUhoUFNFWTJWR0ZRYm1ZNVZVdE5TbFZQWVM5MFIwdExVVDA5Q2kwdExTMHRSVTVFSUVORlVsUkpSa2xEUVZSRkxTMHRMUzBLDQogICAgc2VydmVyOiBodHRwczovLzFhYTgzOTc1LTRjMGUtNGU4Ny1hMjNlLWY4NWFlYWE5OTZlNS5rOHMub25kaWdpdGFsb2NlYW4uY29tDQogIG5hbWU6IGRvLXNmbzMtazhzLTEtMzEtMS1kby00LXNmbzMtMTczMTg0NjMxNjE5Mg0KY29udGV4dHM6DQotIGNvbnRleHQ6DQogICAgY2x1c3RlcjogZG8tc2ZvMy1rOHMtMS0zMS0xLWRvLTQtc2ZvMy0xNzMxODQ2MzE2MTkyDQogICAgdXNlcjogZG8tc2ZvMy1rOHMtMS0zMS0xLWRvLTQtc2ZvMy0xNzMxODQ2MzE2MTkyLWFkbWluDQogIG5hbWU6IGRvLXNmbzMtazhzLTEtMzEtMS1kby00LXNmbzMtMTczMTg0NjMxNjE5Mg0KY3VycmVudC1jb250ZXh0OiBkby1zZm8zLWs4cy0xLTMxLTEtZG8tNC1zZm8zLTE3MzE4NDYzMTYxOTINCmtpbmQ6IENvbmZpZw0KcHJlZmVyZW5jZXM6IHt9DQp1c2VyczoNCi0gbmFtZTogZG8tc2ZvMy1rOHMtMS0zMS0xLWRvLTQtc2ZvMy0xNzMxODQ2MzE2MTkyLWFkbWluDQogIHVzZXI6DQogICAgdG9rZW46IGRvcF92MV9mN2Q1ZDkxMmU0NTc3M2VjNTlkY2RlOTA5MzMwYThjNzBmMjhhOTU1NDQ3NjQwNTEwYjMzMDA5YzYwOWYyNzRmDQo=" > ~/.kube/config

    - name: Apply Kubernetes deployment
      run: |
        kubectl apply -f deployment.yaml
